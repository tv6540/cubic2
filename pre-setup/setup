#!/bin/bash
set -e

REPO_URL="https://github.com/tv6540/cubic2.git"
SETUP_DIR="/tmp/cubic2"
LOG_FILE="$HOME/setup.log"

# Log all output to file and terminal
exec > >(tee -a "$LOG_FILE") 2>&1
echo "=== Setup started at $(date) ==="

# Activate ethernet FIRST before checking network
# Intel e1000e NICs need interface cycle to trigger link negotiation
activate_ethernet() {
  echo "Activating wired ethernet..."
  local path iface
  for path in /sys/class/net/*/device; do
    [ -e "$path" ] || continue
    iface=$(basename "$(dirname "$path")")
    # Skip wireless, virtual, loopback
    [[ "$iface" =~ ^(lo|wl|ww|vir|docker|br-|veth) ]] && continue
    [ -d "/sys/class/net/$iface/wireless" ] && continue

    echo "  Found: $iface - cycling interface..."
    sudo ip link set "$iface" down 2>/dev/null || true
    sleep 1
    sudo ip link set "$iface" up 2>/dev/null || true

    # Restart auto-negotiation if ethtool available
    command -v ethtool &>/dev/null && sudo ethtool -r "$iface" 2>/dev/null || true

    # Wait for link (up to 10 seconds)
    local i
    for i in $(seq 1 10); do
      if [ "$(cat /sys/class/net/$iface/carrier 2>/dev/null)" = "1" ]; then
        echo "  Link detected on $iface"
        sudo nmcli device set "$iface" managed yes 2>/dev/null || true
        nmcli device connect "$iface" 2>/dev/null || true
        return 0
      fi
      sleep 1
    done

    # Force NetworkManager to try even without carrier
    echo "  No carrier, forcing NetworkManager..."
    sudo nmcli device set "$iface" managed yes 2>/dev/null || true
    nmcli device connect "$iface" 2>/dev/null || true
    sleep 2

    if nmcli device status 2>/dev/null | grep -q "$iface.*connected"; then
      echo "  Connected via $iface"
      return 0
    fi
  done
  echo "  No wired connection (will try WiFi)"
  return 1
}

check_online() {
  local retries=0
  local max_retries=360

  while [ $retries -lt $max_retries ]; do
    if ping -c 1 github.com &> /dev/null; then
      echo "Online"
      return 0
    fi
    retries=$((retries + 1))
    echo "Waiting for network... ($retries/$max_retries)"
    sleep 5
  done

  echo ""
  echo "============================================"
  echo "ERROR: No network after $max_retries attempts"
  echo "============================================"
  echo ""
  echo "To recover:"
  echo "  1. Connect to WiFi or plug in ethernet"
  echo "  2. Run: setup"
  echo ""
  exit 1
}

main() {
  # Activate ethernet BEFORE checking connectivity
  activate_ethernet

  echo "Checking internet connectivity..."
  check_online

  # Ensure git is installed
  if ! command -v git &> /dev/null; then
    echo "Installing git..."
    sudo apt-get update -qq
    sudo apt-get install -y -qq git
  fi

  echo "Cloning setup repository..."
  rm -rf "$SETUP_DIR"
  git clone -q "$REPO_URL" "$SETUP_DIR"

  echo "Running setup..."
  chmod +x "$SETUP_DIR/scripts/setup-e6540"
  "$SETUP_DIR/scripts/setup-e6540"
}

main
