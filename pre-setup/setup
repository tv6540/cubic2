#!/bin/bash
set -e

REPO_URL="https://github.com/tv6540/cubic2.git"
SETUP_DIR="/tmp/cubic2"
LOG_FILE="$HOME/setup.log"

# Log all output to file and terminal
exec > >(tee -a "$LOG_FILE") 2>&1
echo "=== Setup started at $(date) ==="

# Try to connect ethernet device
try_ethernet_connect() {
  local dev conn

  dev=$(nmcli -t -f DEVICE,TYPE device 2>/dev/null | grep ':ethernet' | cut -d: -f1 | head -1)
  [ -z "$dev" ] && return 1

  # Try direct connect first
  nmcli device connect "$dev" 2>/dev/null && return 0

  # Try connection profile
  conn=$(nmcli -t -f NAME,TYPE connection show 2>/dev/null | grep ':.*ethernet' | cut -d: -f1 | head -1)
  [ -n "$conn" ] && nmcli connection up "$conn" 2>/dev/null && return 0

  return 1
}

# Check if we're online
is_online() {
  ping -c 1 -W 2 github.com &>/dev/null
}

# Main network activation loop
# Handles: NM restart needed, router not yet on, cable plugged in late
# Waits indefinitely until network is available
activate_and_wait_for_network() {
  local attempt=0

  echo "Activating network..."

  while true; do
    # Check if already online
    if is_online; then
      echo "Online!"
      return 0
    fi

    # Every 12 attempts (60 sec), try to activate ethernet
    # This handles: router was off, cable plugged in late, etc.
    if [ $((attempt % 12)) -eq 0 ]; then
      echo "Attempting ethernet connection..."

      # Try simple connect first
      if try_ethernet_connect; then
        sleep 2
        is_online && { echo "Online!"; return 0; }
      fi

      # Restart NM and try again
      echo "Restarting NetworkManager..."
      sudo systemctl restart NetworkManager
      sleep 3

      # Try connect again after restart
      try_ethernet_connect
      sleep 2
      is_online && { echo "Online!"; return 0; }
    fi

    attempt=$((attempt + 1))
    echo "Waiting for network... ($attempt)"
    sleep 5
  done
}

main() {
  # Combined ethernet activation + network wait
  activate_and_wait_for_network

  # Ensure git is installed
  if ! command -v git &> /dev/null; then
    echo "Installing git..."
    sudo apt-get update -qq
    sudo apt-get install -y -qq git
  fi

  echo "Cloning setup repository..."
  rm -rf "$SETUP_DIR"
  git clone -q "$REPO_URL" "$SETUP_DIR"

  echo "Running setup..."
  chmod +x "$SETUP_DIR/scripts/setup-e6540"
  "$SETUP_DIR/scripts/setup-e6540"
}

main
