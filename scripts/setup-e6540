#!/bin/bash
set -e

# Kill gnome-initial-setup if somehow still running (should be disabled at build time)
echo -e "\n>>>> Ensuring gnome-initial-setup is stopped"
pkill -f gnome-initial-setup 2>/dev/null || true

echo -e "\n>>>> Activating wired ethernet"
# Intel e1000e NICs sometimes don't auto-negotiate on boot (power saving mode)
# Force the interface up to trigger link detection
ETH_IFACE=$(ip link | grep -E "^[0-9]+: (eno|enp|eth)" | head -1 | awk -F': ' '{print $2}')
if [ -n "$ETH_IFACE" ]; then
  echo "Found ethernet interface: $ETH_IFACE"
  sudo ip link set "$ETH_IFACE" up
  sleep 2  # Give time for link negotiation

  # Check if carrier detected
  if [ "$(cat /sys/class/net/$ETH_IFACE/carrier 2>/dev/null)" = "1" ]; then
    echo "Link detected, connecting via NetworkManager..."
    nmcli device connect "$ETH_IFACE" 2>/dev/null || true
  else
    echo "No cable detected on $ETH_IFACE (will use WiFi if available)"
  fi
else
  echo "No ethernet interface found"
fi

echo -e "\n>>>> Configuring displays"
# Auto-detect displays instead of hardcoding names/resolutions
XRANDR_OUTPUT=$(xrandr --current)

# Find connected external display (HDMI, DP, VGA, DVI)
EXTERNAL=$(echo "$XRANDR_OUTPUT" | grep -E "^(HDMI|DP|VGA|DVI)" | grep " connected" | head -1 | awk '{print $1}')

# Find internal display (eDP, LVDS)
INTERNAL=$(echo "$XRANDR_OUTPUT" | grep -E "^(eDP|LVDS)" | grep " connected" | head -1 | awk '{print $1}')

if [ -n "$EXTERNAL" ]; then
  # Get the preferred resolution (marked with + in xrandr output)
  PREFERRED_MODE=$(echo "$XRANDR_OUTPUT" | sed -n "/^$EXTERNAL/,/^[A-Z]/p" | grep -E "^\s+[0-9]+x[0-9]+" | grep "+" | head -1 | awk '{print $1}')

  if [ -n "$PREFERRED_MODE" ]; then
    echo "Setting $EXTERNAL as primary at $PREFERRED_MODE (native resolution)"
    xrandr --output "$EXTERNAL" --primary --mode "$PREFERRED_MODE" && echo "Success" || echo "Warning: $EXTERNAL config failed"
  else
    # Fallback: use --auto for native resolution
    echo "Setting $EXTERNAL as primary (auto resolution)"
    xrandr --output "$EXTERNAL" --primary --auto && echo "Success" || echo "Warning: $EXTERNAL config failed"
  fi

  # Disable internal display if external is connected
  if [ -n "$INTERNAL" ]; then
    echo "Disabling internal display ($INTERNAL)"
    xrandr --output "$INTERNAL" --off && echo "Success" || echo "Warning: $INTERNAL disable failed"
  fi
else
  echo "No external display detected, keeping internal display active"
  # List what was detected for debugging
  echo "Connected displays:"
  echo "$XRANDR_OUTPUT" | grep " connected"
fi

# Screen timeout handled in security section (5 min idle lock)
# Video players auto-inhibit screensaver during playback

echo -e "\n>>>> Setting random wallpaper"
shopt -s nullglob
WALLPAPERS=(/usr/share/backgrounds/custom/wp-*.jpg)
shopt -u nullglob
if [ ${#WALLPAPERS[@]} -gt 0 ]; then
  RANDOM_WP="${WALLPAPERS[RANDOM % ${#WALLPAPERS[@]}]}"
  gsettings set org.gnome.desktop.background picture-uri "file://$RANDOM_WP"
  gsettings set org.gnome.desktop.background picture-uri-dark "file://$RANDOM_WP"
  gsettings set org.gnome.desktop.background picture-options "zoom"
  echo "Applied wallpaper: $RANDOM_WP"
else
  echo "Warning: No wallpapers found in /usr/share/backgrounds/custom/"
  ls -la /usr/share/backgrounds/custom/ 2>/dev/null || echo "Directory doesn't exist"
fi

echo -e "\n>>>> Ignoring lid switch"
if ! grep -q "HandleLidSwitch=ignore" /etc/systemd/logind.conf; then
  echo "HandleLidSwitch=ignore" | sudo tee -a /etc/systemd/logind.conf
fi

echo -e "\n>>>> Setting HDMI audio as default"
if command -v pactl &>/dev/null; then
  HDMI_SINK=$(pactl list short sinks | grep -i hdmi | head -1 | awk '{print $2}')
  if [ -n "$HDMI_SINK" ]; then
    pactl set-default-sink "$HDMI_SINK"
    echo "Set default sink to: $HDMI_SINK"
  else
    echo "Warning: No HDMI sink found"
  fi
else
  echo "Warning: pactl not available, skipping HDMI audio setup"
fi

echo -e "\n>>>> Setting timezone to Pacific"
sudo timedatectl set-timezone America/Los_Angeles

echo -e "\n>>>> Applying security updates and Chrome dependencies"
# Disable locale generation (wastes 30+ seconds during package installs)
sudo mv /usr/sbin/locale-gen /usr/sbin/locale-gen.bak 2>/dev/null || true
sudo ln -sf /bin/true /usr/sbin/locale-gen
sudo mv /usr/bin/localedef /usr/bin/localedef.bak 2>/dev/null || true
sudo ln -sf /bin/true /usr/bin/localedef

sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq
# Chrome required packages (from crash report + GUI deps) - includes security libs
sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq --no-install-recommends --only-upgrade \
  dpkg gpgv libapparmor1 libblkid1 libmount1 \
  libpam-modules libpam-modules-bin libpango-1.0-0 libpangocairo-1.0-0 \
  libpng16-16t64 libsmartcols1 libsqlite3-0 libssl3t64 \
  libsystemd0 libudev1 libuuid1 libxml2 openssl uuid-runtime \
  libc6 libgtk-3-0t64 libgtk-4-1 libglib2.0-0t64 libnss3 libnspr4 \
  libatk1.0-0t64 libcups2t64 libdrm2 libxkbcommon0 libasound2t64 \
  2>/dev/null || true

echo -e "\n>>>> Installing Google Chrome"
cd /tmp
wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo DEBIAN_FRONTEND=noninteractive apt-get install -f -y
rm -f google-chrome-stable_current_amd64.deb

# Chrome sandbox works out of the box when installed via dpkg
# No modification needed - sandbox is properly configured

install_chrome_extension() {
  local ext_id="$1"
  local ext_name="$2"
  local pref_dir="/opt/google/chrome/extensions"
  local pref_file="$pref_dir/$ext_id.json"
  sudo mkdir -p "$pref_dir"
  echo '{"external_update_url":"https://clients2.google.com/service/update2/crx"}' | sudo tee "$pref_file" > /dev/null
  echo "Installed extension: $ext_name"
}

echo -e "\n>>>> Installing Chrome extensions"
install_chrome_extension "cfhdojbkjhnklbpkdaibdccddilifddb" "Adblock Plus"
install_chrome_extension "hmbnhhcgiecenbbkgdoaoafjpeaboine" "Autoskip for Youtubeâ„¢ Ads"

echo -e "\n>>>> Installing VLC"
sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq vlc

# Restore locale tools after all package installs
sudo rm -f /usr/sbin/locale-gen /usr/bin/localedef
sudo mv /usr/sbin/locale-gen.bak /usr/sbin/locale-gen 2>/dev/null || true
sudo mv /usr/bin/localedef.bak /usr/bin/localedef 2>/dev/null || true

echo -e "\n>>>> Installing quick reset command (x)"
sudo cp /tmp/cubic2/scripts/x /usr/bin/x
sudo chmod +x /usr/bin/x

# Note: Dock favorites, dark mode, screen lock, and remote desktop settings
# are pre-configured in the ISO via dconf database (docker-build.sh)

echo -e "\n>>>> Hardening security"
# Enable firewall - deny all incoming, allow outgoing
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw --force enable

# Disable SSH if present
sudo systemctl disable ssh 2>/dev/null || true
sudo systemctl stop ssh 2>/dev/null || true

# Disable Bluetooth (attack surface)
sudo systemctl disable bluetooth 2>/dev/null || true
sudo systemctl stop bluetooth 2>/dev/null || true

# Remount USB as read-only to prevent malware persistence
USB_DEVICE=$(mount | grep /cdrom | awk '{print $1}')
if [ -n "$USB_DEVICE" ]; then
  sudo mount -o remount,ro /cdrom 2>/dev/null || true
  echo "USB remounted read-only"
fi

# Disable fwupd to prevent firmware modifications
sudo systemctl mask fwupd 2>/dev/null || true

echo -e "\n>>>> Cleaning up"
rm -rf /tmp/cubic2

echo -e "\n>>>> Setup complete!"
echo -e "    Tip: Run 'x' anytime to reset display/audio settings."
echo -e "    Log: ~/setup.log"
echo "=== Setup finished at $(date) ==="

echo -e "\n>>>> Launching Chrome..."
sleep 3
if command -v google-chrome-stable &> /dev/null; then
  # Launch Chrome fully detached using systemd-run (survives terminal close)
  # Ref: https://man7.org/linux/man-pages/man1/systemd-run.1.html
  # Ref: https://words.yuvi.in/post/systemd-gui-applications/
  # GUI apps need DISPLAY and DBUS_SESSION_BUS_ADDRESS env vars
  systemd-run --user --no-block \
    --setenv=DISPLAY="$DISPLAY" \
    --setenv=DBUS_SESSION_BUS_ADDRESS="$DBUS_SESSION_BUS_ADDRESS" \
    google-chrome-stable \
    --no-first-run \
    --no-default-browser-check \
    --disable-session-crashed-bubble \
    --no-sandbox \
    --start-fullscreen \
    "https://accounts.google.com/AccountChooser?Email=anandchakru.forum@gmail.com&continue=https://mail.google.com/"
  echo "Chrome launched via systemd"
else
  echo "ERROR: Chrome not found!"
fi
