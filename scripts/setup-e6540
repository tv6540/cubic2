#!/bin/bash
set -e

# Kill gnome-initial-setup if somehow still running (should be disabled at build time)
echo -e "\n>>>> Ensuring gnome-initial-setup is stopped"
pkill -f gnome-initial-setup 2>/dev/null || true

echo -e "\n>>>> Activating wired ethernet"
activate_ethernet() {
  local dev conn attempt

  dev=$(nmcli -t -f DEVICE,TYPE device 2>/dev/null | grep ':ethernet' | cut -d: -f1 | head -1)
  [ -z "$dev" ] && { echo "No ethernet device"; return 1; }

  echo "Found: $dev"

  # Try up to 3 times with NM restart
  for attempt in 1 2 3; do
    echo "Attempt $attempt/3..."

    # Try direct connect
    if nmcli device connect "$dev" 2>/dev/null; then
      echo "Connected!"
      return 0
    fi

    # Try connection profile
    conn=$(nmcli -t -f NAME,TYPE connection show 2>/dev/null | grep ':.*ethernet' | cut -d: -f1 | head -1)
    if [ -n "$conn" ] && nmcli connection up "$conn" 2>/dev/null; then
      echo "Connected!"
      return 0
    fi

    # Restart NM and retry (except on last attempt)
    if [ $attempt -lt 3 ]; then
      echo "Restarting NetworkManager..."
      sudo systemctl restart NetworkManager
      sleep 3
    fi
  done

  echo "No wired connection"
  return 1
}
activate_ethernet

echo -e "\n>>>> Configuring displays"
configure_displays() {
  # Check if running Wayland or X11
  if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
    # On GNOME Wayland, use gnome-randr if available, else xrandr via XWayland
    if command -v gnome-randr &>/dev/null; then
      RANDR_CMD="gnome-randr"
    else
      RANDR_CMD="xrandr"  # Falls back to XWayland compatibility
    fi
  else
    RANDR_CMD="xrandr"
  fi

  local xrandr_out
  xrandr_out=$(xrandr --current 2>/dev/null) || { echo "Warning: xrandr not available"; return 1; }

  # Find connected external display (HDMI, DP, DisplayPort, VGA, DVI)
  # Pattern covers: HDMI-1, HDMI-A-1, DP-1, DisplayPort-1, VGA-1, DVI-I-1, etc.
  local external internal
  external=$(echo "$xrandr_out" | grep -E "^(HDMI|DP|DisplayPort|VGA|DVI)" | grep " connected" | head -1 | awk '{print $1}')

  # Find internal display (eDP, LVDS, DSI for tablets)
  internal=$(echo "$xrandr_out" | grep -E "^(eDP|LVDS|DSI)" | grep " connected" | head -1 | awk '{print $1}')

  if [ -n "$external" ]; then
    # Get preferred resolution (marked with + or * in xrandr output)
    local preferred_mode
    preferred_mode=$(echo "$xrandr_out" | awk -v ext="$external" '
      $1 == ext { found=1; next }
      found && /^[A-Za-z]/ { exit }
      found && /[0-9]+x[0-9]+/ && /\+|\*/ { print $1; exit }
    ')

    # Configure external display
    if [ -n "$preferred_mode" ]; then
      echo "Setting $external as primary at $preferred_mode"
      if ! xrandr --output "$external" --primary --mode "$preferred_mode" 2>/dev/null; then
        echo "Warning: Failed to set $preferred_mode, trying auto..."
        xrandr --output "$external" --primary --auto 2>/dev/null || true
      fi
    else
      echo "Setting $external as primary (auto)"
      xrandr --output "$external" --primary --auto 2>/dev/null || true
    fi

    # Disable internal display only if external is working
    if [ -n "$internal" ] && xrandr --listactivemonitors 2>/dev/null | grep -q "$external"; then
      echo "Disabling internal display ($internal)"
      xrandr --output "$internal" --off 2>/dev/null || echo "Warning: Could not disable $internal"
    fi
  else
    echo "No external display detected"
    # Ensure internal display is active as fallback
    if [ -n "$internal" ]; then
      echo "Keeping internal display ($internal) active"
      xrandr --output "$internal" --auto 2>/dev/null || true
    fi
    echo "Connected displays:"
    echo "$xrandr_out" | grep " connected" || echo "  (none detected)"
  fi
}
configure_displays

# Screen timeout handled in security section (5 min idle lock)
# Video players auto-inhibit screensaver during playback

echo -e "\n>>>> Setting random wallpaper"
shopt -s nullglob
WALLPAPERS=(/usr/share/backgrounds/custom/wp-*.jpg)
shopt -u nullglob
if [ ${#WALLPAPERS[@]} -gt 0 ]; then
  RANDOM_WP="${WALLPAPERS[RANDOM % ${#WALLPAPERS[@]}]}"
  gsettings set org.gnome.desktop.background picture-uri "file://$RANDOM_WP"
  gsettings set org.gnome.desktop.background picture-uri-dark "file://$RANDOM_WP"
  gsettings set org.gnome.desktop.background picture-options "zoom"
  echo "Applied wallpaper: $RANDOM_WP"
else
  echo "Warning: No wallpapers found in /usr/share/backgrounds/custom/"
  ls -la /usr/share/backgrounds/custom/ 2>/dev/null || echo "Directory doesn't exist"
fi

echo -e "\n>>>> Ignoring lid switch"
if ! grep -q "HandleLidSwitch=ignore" /etc/systemd/logind.conf; then
  echo "HandleLidSwitch=ignore" | sudo tee -a /etc/systemd/logind.conf
fi

echo -e "\n>>>> Setting audio output"
configure_audio() {
  if ! command -v pactl &>/dev/null; then
    echo "Warning: pactl not available"
    return 1
  fi

  # Wait a moment for audio to initialize after display changes
  sleep 1

  # Try HDMI/DisplayPort audio first (covers HDMI and DP)
  local hdmi_sink
  hdmi_sink=$(pactl list short sinks 2>/dev/null | grep -iE "hdmi|displayport" | head -1 | awk '{print $2}')

  if [ -n "$hdmi_sink" ]; then
    pactl set-default-sink "$hdmi_sink" && echo "Audio: $hdmi_sink" || echo "Warning: Failed to set $hdmi_sink"
  else
    # No HDMI sink - use first available sink (usually built-in speakers)
    local default_sink
    default_sink=$(pactl list short sinks 2>/dev/null | head -1 | awk '{print $2}')
    if [ -n "$default_sink" ]; then
      echo "No HDMI audio, using: $default_sink"
      pactl set-default-sink "$default_sink" 2>/dev/null || true
    else
      echo "Warning: No audio sinks found"
    fi
  fi
}
configure_audio

echo -e "\n>>>> Setting timezone to Pacific"
sudo timedatectl set-timezone America/Los_Angeles

echo -e "\n>>>> Applying security updates and Chrome dependencies"
# Disable locale generation (wastes 30+ seconds during package installs)
sudo mv /usr/sbin/locale-gen /usr/sbin/locale-gen.bak 2>/dev/null || true
sudo ln -sf /bin/true /usr/sbin/locale-gen
sudo mv /usr/bin/localedef /usr/bin/localedef.bak 2>/dev/null || true
sudo ln -sf /bin/true /usr/bin/localedef

sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq
# Chrome required packages (from crash report + GUI deps) - includes security libs
sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq --no-install-recommends --only-upgrade \
  dpkg gpgv libapparmor1 libblkid1 libmount1 \
  libpam-modules libpam-modules-bin libpango-1.0-0 libpangocairo-1.0-0 \
  libpng16-16t64 libsmartcols1 libsqlite3-0 libssl3t64 \
  libsystemd0 libudev1 libuuid1 libxml2 openssl uuid-runtime \
  libc6 libgtk-3-0t64 libgtk-4-1 libglib2.0-0t64 libnss3 libnspr4 \
  libatk1.0-0t64 libcups2t64 libdrm2 libxkbcommon0 libasound2t64 \
  2>/dev/null || true

echo -e "\n>>>> Installing Google Chrome"
cd /tmp
wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo DEBIAN_FRONTEND=noninteractive apt-get install -f -y
rm -f google-chrome-stable_current_amd64.deb

# Chrome sandbox works out of the box when installed via dpkg
# No modification needed - sandbox is properly configured

install_chrome_extension() {
  local ext_id="$1"
  local ext_name="$2"
  local pref_dir="/opt/google/chrome/extensions"
  local pref_file="$pref_dir/$ext_id.json"
  sudo mkdir -p "$pref_dir"
  echo '{"external_update_url":"https://clients2.google.com/service/update2/crx"}' | sudo tee "$pref_file" > /dev/null
  echo "Installed extension: $ext_name"
}

echo -e "\n>>>> Installing Chrome extensions"
install_chrome_extension "cfhdojbkjhnklbpkdaibdccddilifddb" "Adblock Plus"
install_chrome_extension "hmbnhhcgiecenbbkgdoaoafjpeaboine" "Autoskip for Youtubeâ„¢ Ads"

echo -e "\n>>>> Installing VLC"
sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq vlc

# Restore locale tools after all package installs
sudo rm -f /usr/sbin/locale-gen /usr/bin/localedef
sudo mv /usr/sbin/locale-gen.bak /usr/sbin/locale-gen 2>/dev/null || true
sudo mv /usr/bin/localedef.bak /usr/bin/localedef 2>/dev/null || true

echo -e "\n>>>> Installing quick reset command (x)"
sudo cp /tmp/cubic2/scripts/x /usr/bin/x
sudo chmod +x /usr/bin/x

# Note: Dock favorites, dark mode, screen lock, and remote desktop settings
# are pre-configured in the ISO via dconf database (docker-build.sh)

echo -e "\n>>>> Hardening security"
# Enable firewall - deny all incoming, allow outgoing
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw --force enable

# Disable SSH if present
sudo systemctl disable ssh 2>/dev/null || true
sudo systemctl stop ssh 2>/dev/null || true

# Disable Bluetooth (attack surface)
sudo systemctl disable bluetooth 2>/dev/null || true
sudo systemctl stop bluetooth 2>/dev/null || true

# Remount USB as read-only to prevent malware persistence
USB_DEVICE=$(mount | grep /cdrom | awk '{print $1}')
if [ -n "$USB_DEVICE" ]; then
  sudo mount -o remount,ro /cdrom 2>/dev/null || true
  echo "USB remounted read-only"
fi

# Disable fwupd to prevent firmware modifications
sudo systemctl mask fwupd 2>/dev/null || true

echo -e "\n>>>> Cleaning up"
rm -rf /tmp/cubic2

echo -e "\n>>>> Setup complete!"
echo -e "    Tip: Run 'x' anytime to reset display/audio settings."
echo -e "    Log: ~/setup.log"
echo "=== Setup finished at $(date) ==="

echo -e "\n>>>> Launching Chrome..."
sleep 3
if command -v google-chrome-stable &> /dev/null; then
  # Launch Chrome fully detached using systemd-run (survives terminal close)
  # Ref: https://man7.org/linux/man-pages/man1/systemd-run.1.html
  # Ref: https://words.yuvi.in/post/systemd-gui-applications/
  # GUI apps need DISPLAY and DBUS_SESSION_BUS_ADDRESS env vars
  systemd-run --user --no-block \
    --setenv=DISPLAY="$DISPLAY" \
    --setenv=DBUS_SESSION_BUS_ADDRESS="$DBUS_SESSION_BUS_ADDRESS" \
    google-chrome-stable \
    --no-first-run \
    --no-default-browser-check \
    --disable-session-crashed-bubble \
    --no-sandbox \
    --start-fullscreen \
    "https://accounts.google.com/AccountChooser?Email=anandchakru.forum@gmail.com&continue=https://mail.google.com/"
  echo "Chrome launched via systemd"
else
  echo "ERROR: Chrome not found!"
fi
