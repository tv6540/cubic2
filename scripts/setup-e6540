#!/bin/bash
set -e

# Note: Package removal (Firefox, LibreOffice, etc.) is done at ISO build time
# via chroot in docker-build.sh for smaller ISO and reduced attack surface

echo -e "\n>>>> Setting HDMI-1 as primary at 1600x900"
xrandr --output HDMI-1 --primary --mode 1600x900 || echo "Warning: HDMI-1 config failed, skipping"

echo -e "\n>>>> Disabling built-in display (eDP-1)"
xrandr --output eDP-1 --off || echo "Warning: eDP-1 disable failed, skipping"

# Screen timeout handled in security section (5 min idle lock)
# Video players auto-inhibit screensaver during playback

echo -e "\n>>>> Ignoring lid switch"
if ! grep -q "HandleLidSwitch=ignore" /etc/systemd/logind.conf; then
  echo "HandleLidSwitch=ignore" | sudo tee -a /etc/systemd/logind.conf
fi

echo -e "\n>>>> Setting HDMI audio as default"
HDMI_SINK=$(pactl list short sinks | grep -i hdmi | head -1 | awk '{print $2}')
if [ -n "$HDMI_SINK" ]; then
  pactl set-default-sink "$HDMI_SINK"
fi

echo -e "\n>>>> Setting timezone to Pacific"
sudo timedatectl set-timezone America/Los_Angeles

echo -e "\n>>>> Installing Google Chrome"
cd /tmp
wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get install -f -y
rm -f google-chrome-stable_current_amd64.deb

# Fix Chrome sandbox issue for live USB
sudo sed -i 's|Exec=/usr/bin/google-chrome-stable|Exec=/usr/bin/google-chrome-stable --no-sandbox|g' /usr/share/applications/google-chrome.desktop

install_chrome_extension() {
  local ext_id="$1"
  local ext_name="$2"
  local pref_dir="/opt/google/chrome/extensions"
  local pref_file="$pref_dir/$ext_id.json"
  sudo mkdir -p "$pref_dir"
  echo '{"external_update_url":"https://clients2.google.com/service/update2/crx"}' | sudo tee "$pref_file" > /dev/null
  echo "Installed extension: $ext_name"
}

echo -e "\n>>>> Installing Chrome extensions"
install_chrome_extension "cfhdojbkjhnklbpkdaibdccddilifddb" "Adblock Plus"
install_chrome_extension "hmbnhhcgiecenbbkgdoaoafjpeaboine" "Autoskip for Youtubeâ„¢ Ads"

echo -e "\n>>>> Installing VLC"
sudo apt install -y vlc

echo -e "\n>>>> Installing quick reset command (x)"
sudo cp /tmp/cubic2/scripts/x /usr/bin/x
sudo chmod +x /usr/bin/x

# Note: Dock favorites, dark mode, screen lock, and remote desktop settings
# are pre-configured in the ISO via dconf database (docker-build.sh)

echo -e "\n>>>> Hardening security"
# Enable firewall - deny all incoming, allow outgoing
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw --force enable

# Disable SSH if present
sudo systemctl disable ssh 2>/dev/null || true
sudo systemctl stop ssh 2>/dev/null || true

# Disable Bluetooth (attack surface)
sudo systemctl disable bluetooth 2>/dev/null || true
sudo systemctl stop bluetooth 2>/dev/null || true

# Remount USB as read-only to prevent malware persistence
USB_DEVICE=$(mount | grep /cdrom | awk '{print $1}')
if [ -n "$USB_DEVICE" ]; then
  sudo mount -o remount,ro /cdrom 2>/dev/null || true
  echo "USB remounted read-only"
fi

# Disable fwupd to prevent firmware modifications
sudo systemctl mask fwupd 2>/dev/null || true

echo -e "\n>>>> Cleaning up"
rm -rf /tmp/cubic2

echo -e "\n>>>> Setup complete!"
echo -e "    Tip: Run 'x' anytime to reset display/audio settings."
echo -e "    Log: ~/setup.log"
echo "=== Setup finished at $(date) ==="

echo -e "\n>>>> Launching Chrome..."
sleep 3
if command -v google-chrome-stable &> /dev/null; then
  # Use setsid to fully detach from terminal session
  # Ref: https://www.baeldung.com/linux/detach-process-from-terminal
  # --no-first-run: skip first run experience
  # --no-default-browser-check: skip default browser prompt
  # --disable-session-crashed-bubble: no crash recovery prompt
  setsid google-chrome-stable \
    --no-sandbox \
    --no-first-run \
    --no-default-browser-check \
    --disable-session-crashed-bubble \
    --start-fullscreen \
    "https://accounts.google.com/v3/signin/identifier?Email=anandchakru.forum@gmail.com&continue=https://mail.google.com/" \
    </dev/null >/dev/null 2>&1 &
  echo "Chrome launched (PID: $!)"
else
  echo "ERROR: Chrome not found!"
fi
