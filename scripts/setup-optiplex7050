#!/bin/bash
set -e

LOG_FILE="$HOME/setup.log"
exec > >(tee -a "$LOG_FILE") 2>&1
echo "=== Setup started at $(date) ==="

# Display setup - OptiPlex 7050 has: 2x DP 1.2, 1x HDMI 1.4, 1x VGA
echo -e ">>>> Detecting connected display"
CONNECTED_OUTPUT=$(xrandr | grep -E "^(HDMI|DP|VGA|DisplayPort)" | grep " connected" | head -1 | awk '{print $1}')
if [ -z "$CONNECTED_OUTPUT" ]; then
  echo "Warning: No external display detected, skipping display config"
else
  echo "Found display on: $CONNECTED_OUTPUT"

  # Try 1920x1080 first, fallback to 1600x900 if it fails (for older TVs)
  if xrandr | grep -q "1920x1080"; then
    echo "Setting resolution to 1920x1080"
    xrandr --output "$CONNECTED_OUTPUT" --primary --mode 1920x1080 || \
      xrandr --output "$CONNECTED_OUTPUT" --primary --mode 1600x900
  else
    echo "Setting resolution to 1600x900"
    xrandr --output "$CONNECTED_OUTPUT" --primary --mode 1600x900
  fi
fi

echo -e "\n>>>> Set screen timeout to never"
gsettings set org.gnome.desktop.session idle-delay 0

echo -e "\n>>>> Set audio output"
# Ubuntu 24.04 uses PipeWire - prefer HDMI/DP audio if available
HDMI_SINK=$(pactl list short sinks | grep -iE "hdmi|dp" | head -1 | awk '{print $2}')
if [ -n "$HDMI_SINK" ]; then
  pactl set-default-sink "$HDMI_SINK"
  echo "Audio set to: $HDMI_SINK"
else
  echo "No HDMI/DP audio sink found, using default"
fi

echo -e "\n>>>> Set timezone to PT"
sudo timedatectl set-timezone America/Los_Angeles

echo -e "\n>>>> Activating wired ethernet"
dev=$(nmcli -t -f DEVICE,TYPE device 2>/dev/null | grep ':ethernet' | cut -d: -f1 | head -1)
[ -n "$dev" ] && nmcli device connect "$dev" 2>/dev/null || true

echo -e "\n>>>> Mounting internal drives"
FIRST_MOUNT=""
for dev in $(lsblk -rno NAME,TYPE,RM,MOUNTPOINT 2>/dev/null | awk '$2=="part" && $3=="0" && $4=="" {print $1}'); do
  devpath="/dev/$dev"
  if mount | grep -q "^$devpath"; then
    mp=$(mount | grep "^$devpath" | awk '{print $3}')
    echo "  $dev already at $mp"
    [ -z "$FIRST_MOUNT" ] && FIRST_MOUNT="$mp"
  elif mp=$(udisksctl mount -b "$devpath" 2>/dev/null | grep -oP "at \K/.*"); then
    echo "  Mounted $dev at $mp"
    [ -z "$FIRST_MOUNT" ] && FIRST_MOUNT="$mp"
  fi
done
[ -n "$FIRST_MOUNT" ] && echo "First mount: $FIRST_MOUNT"

echo -e "\n>>>> Installing Chrome"
cd /tmp
wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
sudo dpkg -i google-chrome-stable_current_amd64.deb 2>/dev/null || sudo apt-get install -f -y
rm -f google-chrome-stable_current_amd64.deb

install_chrome_extension() {
  local ext_id="$1" ext_name="$2"
  sudo mkdir -p /opt/google/chrome/extensions
  echo "{\"external_update_url\":\"https://clients2.google.com/service/update2/crx\"}" | \
    sudo tee "/opt/google/chrome/extensions/$ext_id.json" > /dev/null
  echo "  Installed: $ext_name"
}

echo -e "\n>>>> Installing Chrome extensions"
install_chrome_extension "cfhdojbkjhnklbpkdaibdccddilifddb" "Adblock Plus"
install_chrome_extension "hmbnhhcgiecenbbkgdoaoafjpeaboine" "Autoskip for Youtube Ads"

# Set Chrome download directory if internal drive mounted
if [ -n "$FIRST_MOUNT" ]; then
  DOWNLOAD_DIR="$FIRST_MOUNT/Downloads"
  mkdir -p "$DOWNLOAD_DIR" 2>/dev/null || true
  mkdir -p ~/.config/google-chrome/Default 2>/dev/null || true
  echo "{\"download\":{\"default_directory\":\"$DOWNLOAD_DIR\"}}" > ~/.config/google-chrome/Default/Preferences 2>/dev/null || true
  echo "Chrome download dir: $DOWNLOAD_DIR"
fi

echo -e "\n>>>> Launching Chrome"
nohup google-chrome-stable \
  --no-first-run \
  --no-default-browser-check \
  --disable-session-crashed-bubble \
  --start-maximized \
  "https://accounts.google.com/AccountChooser?Email=anandchakru.forum@gmail.com&continue=https://mail.google.com/" \
  > /dev/null 2>&1 &
disown

echo -e "\n>>>> Installing VLC"
sudo apt-get update -qq
sudo apt-get install -y -qq vlc 2>/dev/null || true

echo -e "\n>>>> Installing quick reset command (x)"
sudo cp /tmp/cubic2/scripts/x /usr/bin/x 2>/dev/null || true
sudo chmod +x /usr/bin/x 2>/dev/null || true

echo -e "\n>>>> Setting dock favorites"
gsettings set org.gnome.shell favorite-apps "['google-chrome.desktop', 'vlc.desktop', 'org.gnome.Nautilus.desktop', 'org.gnome.Terminal.desktop']" 2>/dev/null || true

echo -e "\n>>>> Security hardening"
sudo ufw default deny incoming >/dev/null 2>&1 || true
sudo ufw default allow outgoing >/dev/null 2>&1 || true
sudo ufw --force enable >/dev/null 2>&1 || true
sudo systemctl disable --now ssh 2>/dev/null || true
sudo systemctl disable --now bluetooth 2>/dev/null || true
sudo mount -o remount,ro /cdrom 2>/dev/null || true

echo -e "\n>>>> Cleanup"
rm -rf /tmp/cubic2

echo -e "\n>>>> Setup complete!"
echo "=== Setup finished at $(date) ==="
