#!/bin/bash
# Quick display/audio reset - run with: x

echo -e ">>>> Activating wired ethernet"
ETH_IFACE=$(ip link | grep -E "^[0-9]+: (eno|enp|eth)" | head -1 | awk -F': ' '{print $2}')
if [ -n "$ETH_IFACE" ]; then
  sudo ip link set "$ETH_IFACE" up 2>/dev/null
  sleep 1
  if [ "$(cat /sys/class/net/$ETH_IFACE/carrier 2>/dev/null)" = "1" ]; then
    nmcli device connect "$ETH_IFACE" 2>/dev/null && echo "$ETH_IFACE connected" || true
  fi
fi

echo -e "\n>>>> Configuring displays"
XRANDR_OUTPUT=$(xrandr --current)

# Find connected external display (HDMI, DP, VGA, DVI)
EXTERNAL=$(echo "$XRANDR_OUTPUT" | grep -E "^(HDMI|DP|VGA|DVI)" | grep " connected" | head -1 | awk '{print $1}')

# Find internal display (eDP, LVDS)
INTERNAL=$(echo "$XRANDR_OUTPUT" | grep -E "^(eDP|LVDS)" | grep " connected" | head -1 | awk '{print $1}')

if [ -n "$EXTERNAL" ]; then
  # Get the preferred resolution (marked with + in xrandr output)
  PREFERRED_MODE=$(echo "$XRANDR_OUTPUT" | sed -n "/^$EXTERNAL/,/^[A-Z]/p" | grep -E "^\s+[0-9]+x[0-9]+" | grep "+" | head -1 | awk '{print $1}')

  if [ -n "$PREFERRED_MODE" ]; then
    echo "Setting $EXTERNAL as primary at $PREFERRED_MODE"
    xrandr --output "$EXTERNAL" --primary --mode "$PREFERRED_MODE"
  else
    echo "Setting $EXTERNAL as primary (auto)"
    xrandr --output "$EXTERNAL" --primary --auto
  fi

  if [ -n "$INTERNAL" ]; then
    echo "Disabling internal display ($INTERNAL)"
    xrandr --output "$INTERNAL" --off
  fi
else
  echo "No external display found"
  echo "$XRANDR_OUTPUT" | grep " connected"
fi

echo -e "\n>>>> Setting screen timeout to never"
gsettings set org.gnome.desktop.session idle-delay 0

echo -e "\n>>>> Setting HDMI audio as default"
HDMI_SINK=$(pactl list short sinks | grep -i hdmi | head -1 | awk '{print $2}')
if [ -n "$HDMI_SINK" ]; then
  pactl set-default-sink "$HDMI_SINK"
  echo "Audio: $HDMI_SINK"
else
  echo "No HDMI audio sink found"
fi

echo -e "\n>>>> Done"
