#!/bin/bash
# Quick display/audio/network reset - run with: x

echo -e ">>>> Activating wired ethernet"
for path in /sys/class/net/*/device; do
  [ -e "$path" ] || continue
  iface=$(basename "$(dirname "$path")")
  [[ "$iface" =~ ^(lo|wl|ww|vir|docker|br-|veth) ]] && continue
  [ -d "/sys/class/net/$iface/wireless" ] && continue

  echo "Cycling $iface..."
  sudo ip link set "$iface" down 2>/dev/null; sleep 1
  sudo ip link set "$iface" up 2>/dev/null
  command -v ethtool &>/dev/null && sudo ethtool -r "$iface" 2>/dev/null

  # Wait up to 5 seconds for link
  for i in 1 2 3 4 5; do
    [ "$(cat /sys/class/net/$iface/carrier 2>/dev/null)" = "1" ] && break
    sleep 1
  done

  # Try to connect regardless of carrier
  sudo nmcli device set "$iface" managed yes 2>/dev/null
  nmcli device connect "$iface" 2>/dev/null && echo "$iface connected" && break
done

echo -e "\n>>>> Configuring displays"
XRANDR_OUT=$(xrandr --current 2>/dev/null) || { echo "xrandr failed"; exit 1; }

# Find external display (HDMI, DP, DisplayPort, VGA, DVI)
EXTERNAL=$(echo "$XRANDR_OUT" | grep -E "^(HDMI|DP|DisplayPort|VGA|DVI)" | grep " connected" | head -1 | awk '{print $1}')

# Find internal display (eDP, LVDS, DSI)
INTERNAL=$(echo "$XRANDR_OUT" | grep -E "^(eDP|LVDS|DSI)" | grep " connected" | head -1 | awk '{print $1}')

if [ -n "$EXTERNAL" ]; then
  # Get preferred resolution
  PREFERRED=$(echo "$XRANDR_OUT" | awk -v ext="$EXTERNAL" '
    $1 == ext { found=1; next }
    found && /^[A-Za-z]/ { exit }
    found && /[0-9]+x[0-9]+/ && /\+|\*/ { print $1; exit }
  ')

  if [ -n "$PREFERRED" ]; then
    echo "Setting $EXTERNAL at $PREFERRED"
    xrandr --output "$EXTERNAL" --primary --mode "$PREFERRED" 2>/dev/null || \
      xrandr --output "$EXTERNAL" --primary --auto 2>/dev/null || true
  else
    echo "Setting $EXTERNAL (auto)"
    xrandr --output "$EXTERNAL" --primary --auto 2>/dev/null || true
  fi

  # Disable internal only if external is active
  if [ -n "$INTERNAL" ] && xrandr --listactivemonitors 2>/dev/null | grep -q "$EXTERNAL"; then
    echo "Disabling $INTERNAL"
    xrandr --output "$INTERNAL" --off 2>/dev/null || true
  fi
else
  echo "No external display found"
  [ -n "$INTERNAL" ] && xrandr --output "$INTERNAL" --auto 2>/dev/null
  echo "$XRANDR_OUT" | grep " connected"
fi

echo -e "\n>>>> Setting screen timeout to never"
gsettings set org.gnome.desktop.session idle-delay 0 2>/dev/null || true

echo -e "\n>>>> Setting audio output"
if command -v pactl &>/dev/null; then
  sleep 1  # Wait for audio to init after display change
  HDMI_SINK=$(pactl list short sinks 2>/dev/null | grep -iE "hdmi|displayport" | head -1 | awk '{print $2}')
  if [ -n "$HDMI_SINK" ]; then
    pactl set-default-sink "$HDMI_SINK" && echo "Audio: $HDMI_SINK"
  else
    DEFAULT_SINK=$(pactl list short sinks 2>/dev/null | head -1 | awk '{print $2}')
    [ -n "$DEFAULT_SINK" ] && echo "Audio: $DEFAULT_SINK (no HDMI)"
  fi
fi

echo -e "\n>>>> Done"
