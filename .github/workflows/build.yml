name: Build ISO

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build ISO
        run: ./make.sh build

      - name: Verify ISO
        run: |
          ISO_FILE="ubuntu-*-e6540.iso"
          if ls $ISO_FILE 1>/dev/null 2>&1; then
            echo "ISO created successfully"
            ls -lh $ISO_FILE
            # Verify boot structure
            xorriso -indev $ISO_FILE -report_el_torito as_mkisofs 2>&1 | grep -q "grub2-mbr" && echo "Boot structure OK"
          else
            echo "ISO not found!"
            exit 1
          fi

      - name: Upload ISO (on main only)
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-e6540-iso
          path: ubuntu-*-e6540.iso
          retention-days: 7
